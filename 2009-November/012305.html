<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Openocd-development] [PATCH 4/4] Add 'nand verify' command
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-development/2009-November/index.html" >
   <LINK REL="made" HREF="mailto:openocd-development%40lists.berlios.de?Subject=Re%3A%20%5BOpenocd-development%5D%20%5BPATCH%204/4%5D%20Add%20%27nand%20verify%27%20command&In-Reply-To=%3C1258147035-21734-5-git-send-email-zw%40superlucidity.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012304.html">
   <LINK REL="Next"  HREF="012416.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Openocd-development] [PATCH 4/4] Add 'nand verify' command</H1>
    <B>Zachary T Welch</B> 
    <A HREF="mailto:openocd-development%40lists.berlios.de?Subject=Re%3A%20%5BOpenocd-development%5D%20%5BPATCH%204/4%5D%20Add%20%27nand%20verify%27%20command&In-Reply-To=%3C1258147035-21734-5-git-send-email-zw%40superlucidity.net%3E"
       TITLE="[Openocd-development] [PATCH 4/4] Add 'nand verify' command">zw at superlucidity.net
       </A><BR>
    <I>Fri Nov 13 22:17:15 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="012304.html">[Openocd-development] [PATCH 3/4] Add FILEIO_NONE access mode.
</A></li>
        <LI>Next message: <A HREF="012416.html">[Openocd-development] [PUSHED 4/4] Factor NAND write/dump to add verify
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12305">[ date ]</a>
              <a href="thread.html#12305">[ thread ]</a>
              <a href="subject.html#12305">[ subject ]</a>
              <a href="author.html#12305">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Add the 'nand verify' command to perform a dump and fake-write
simultaneously, checking the read bits against those generated by the
write process.  Appropriate user documentation for this command has
been added to the user guide as well.

The algorithm presently makes a relatively naive comparison.  Some chips
that use ECC may not verify correctly using this implementation, but the
new documentation provides details about this limitation.

Signed-off-by: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-development">zw at superlucidity.net</A>&gt;
---
 doc/openocd.texi |   26 ++++++++++++++++++++++
 src/flash/nand.c |   62 ++++++++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 88 insertions(+), 0 deletions(-)

diff --git a/doc/openocd.texi b/doc/openocd.texi
index bb96a2e..81409ac 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -4620,6 +4620,32 @@ the underlying driver from applying hardware ECC.
 @end itemize
 @end deffn
 
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-development">+ at deffn</A> Command {nand verify} num filename offset [option...]
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-development">+ at cindex</A> NAND verification
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-development">+ at cindex</A> NAND programming
+Verify the binary data in the file has been programmed to the
+specified NAND device, starting at the specified offset.
+The @var{num} parameter is the value shown by @command{nand list}.
+
+Use a complete path name for @var{filename}, so you don't depend
+on the directory used to start the OpenOCD server.
+
+The @var{offset} must be an exact multiple of the device's page size.
+All data in the file will be read and compared to the contents of the
+flash, assuming it doesn't run past the end of the device.
+As with @command{nand write}, only full pages are verified, so any extra
+space in the last page will be filled with 0xff bytes.
+
+The same @var{options} accepted by @command{nand write},
+and the file will be processed similarly to produce the buffers that
+can be compared against the contents produced from @command{nand dump}.
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-development">+ at b</A>{NOTE:} This will not work when the underlying NAND controller
+driver's @code{write_page} routine must update the OOB with a
+hardward-computed ECC before the data is written.  This limitation may
+be removed in a future release.
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-development">+ at end</A> deffn
+
 @section Other NAND commands
 @cindex NAND other commands
 
diff --git a/src/flash/nand.c b/src/flash/nand.c
index d5ce822..796500d 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -1543,6 +1543,68 @@ COMMAND_HANDLER(handle_nand_write_command)
 	return ERROR_OK;
 }
 
+static int handle_nand_verify_command(struct command_context_s *cmd_ctx,
+		char *cmd, char **args, int argc)
+{
+	nand_device_t *p = NULL;
+	struct nand_fileio_state file;
+	int retval = nand_fileio_parse_args(cmd_ctx, args, argc,
+			&amp;file, &amp;p, FILEIO_READ, false, true);
+	if (ERROR_OK != retval)
+		return retval;
+
+	struct nand_fileio_state dev;
+	nand_fileio_init(&amp;dev);
+	dev.address = file.address;
+	dev.size = file.size;
+	dev.oob_format = file.oob_format;
+	retval = nand_fileio_start(cmd_ctx, p, NULL, FILEIO_NONE, &amp;dev);
+	if (ERROR_OK != retval)
+		return retval;
+
+	while (file.size &gt; 0)
+	{
+		int retval = nand_read_page(p, dev.address / dev.page_size,
+				dev.page, dev.page_size, dev.oob, dev.oob_size);
+		if (ERROR_OK != retval)
+		{
+			command_print(cmd_ctx, &quot;reading NAND flash page failed&quot;);
+			nand_fileio_cleanup(&amp;dev);
+			return nand_fileio_cleanup(&amp;file);
+		}
+
+		int bytes_read = nand_fileio_read(p, &amp;file);
+		if (bytes_read &lt;= 0)
+		{
+			command_print(cmd_ctx, &quot;error while reading file&quot;);
+			nand_fileio_cleanup(&amp;dev);
+			return nand_fileio_cleanup(&amp;file);
+		}
+
+		if ((dev.page &amp;&amp; memcmp(dev.page, file.page, dev.page_size)) ||
+		    (dev.oob &amp;&amp; memcmp(dev.oob, file.oob, dev.oob_size)) )
+		{
+			command_print(cmd_ctx, &quot;NAND flash contents differ &quot;
+						&quot;at 0x%8.8&quot; PRIx32, dev.address);
+			nand_fileio_cleanup(&amp;dev);
+			return nand_fileio_cleanup(&amp;file);
+		}
+
+		file.size -= bytes_read;
+		file.address += p-&gt;page_size;
+	}
+
+	if (nand_fileio_finish(&amp;file) == ERROR_OK)
+	{
+		command_print(cmd_ctx, &quot;verified file %s in NAND flash %s &quot;
+				&quot;up to offset 0x%8.8&quot; PRIx32 &quot; in %fs (%0.3f kb/s)&quot;,
+				args[1], args[0], dev.address, duration_elapsed(&amp;file.bench),
+				duration_kbps(&amp;file.bench, dev.size));
+	}
+
+	return nand_fileio_cleanup(&amp;dev);
+}
+
 COMMAND_HANDLER(handle_nand_dump_command)
 {
 	struct nand_device *nand = NULL;
-- 
1.6.4.4


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012304.html">[Openocd-development] [PATCH 3/4] Add FILEIO_NONE access mode.
</A></li>
	<LI>Next message: <A HREF="012416.html">[Openocd-development] [PUSHED 4/4] Factor NAND write/dump to add verify
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12305">[ date ]</a>
              <a href="thread.html#12305">[ thread ]</a>
              <a href="subject.html#12305">[ subject ]</a>
              <a href="author.html#12305">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-development">More information about the Openocd-development
mailing list</a><br>
</body></html>
