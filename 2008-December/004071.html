<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Openocd-development] Unexpected idcode causing SIGSEGV ?
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-development/2008-December/index.html" >
   <LINK REL="made" HREF="mailto:openocd-development%40lists.berlios.de?Subject=Re%3A%20%5BOpenocd-development%5D%20Unexpected%20idcode%20causing%20SIGSEGV%20%3F&In-Reply-To=%3C4947BFCA.4030903%40gin.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004058.html">
   <LINK REL="Next"  HREF="004089.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Openocd-development] Unexpected idcode causing SIGSEGV ?</H1>
    <B>Andreas Kuehn</B> 
    <A HREF="mailto:openocd-development%40lists.berlios.de?Subject=Re%3A%20%5BOpenocd-development%5D%20Unexpected%20idcode%20causing%20SIGSEGV%20%3F&In-Reply-To=%3C4947BFCA.4030903%40gin.de%3E"
       TITLE="[Openocd-development] Unexpected idcode causing SIGSEGV ?">Andreas.Kuehn at gin.de
       </A><BR>
    <I>Tue Dec 16 15:48:42 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="004058.html">[Openocd-development] Unexpected idcode causing SIGSEGV ?
</A></li>
        <LI>Next message: <A HREF="004089.html">[Openocd-development] Unexpected idcode causing SIGSEGV ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4071">[ date ]</a>
              <a href="thread.html#4071">[ thread ]</a>
              <a href="subject.html#4071">[ subject ]</a>
              <a href="author.html#4071">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Everybody!

In the meantime I did a few things. I recompiled my buildroot env. 
completely, got the latest openocd (svn:1245M) and pulled out some *red 
herrings* from the scene. Then I found out that the syntax of the 
configuration files changed again and adapted my scripts. But I can't 
get it going. It looks like some trigger is missing. Probably my 
adaption is not that smooth. At least I haven't received any segfaults 
(so far).


#&gt; ./openocd -f jtagA9263.cfg -d 3

Open On-Chip Debugger 1.0 (2008-12-16-09:17) svn:1245M


BUGS? Read <A HREF="http://svn.berlios.de/svnroot/repos/openocd/trunk/BUGS">http://svn.berlios.de/svnroot/repos/openocd/trunk/BUGS</A>


$URL: <A HREF="http://svn.berlios.de/svnroot/repos/openocd/trunk/src/openocd.c">http://svn.berlios.de/svnroot/repos/openocd/trunk/src/openocd.c</A> $
Debug:   5 6 configuration.c:88 find_file(): found jtagA9263.cfg
Debug:   7 14 command.c:91 script_command(): script_command - telnet_port
Debug:   8 15 command.c:108 script_command(): script_command - 
telnet_port, argv[0]=ocd_telnet_port
Debug:   9 15 command.c:108 script_command(): script_command - 
telnet_port, argv[1]=4444
Debug:   11 17 command.c:91 script_command(): script_command - gdb_port
Debug:   12 17 command.c:108 script_command(): script_command - 
gdb_port, argv[0]=ocd_gdb_port
Debug:   13 18 command.c:108 script_command(): script_command - 
gdb_port, argv[1]=3333
Debug:   15 19 command.c:91 script_command(): script_command - interface
Debug:   16 20 command.c:108 script_command(): script_command - 
interface, argv[0]=ocd_interface
Debug:   17 21 command.c:108 script_command(): script_command - 
interface, argv[1]=at91sam926x
Debug:   19 23 command.c:91 script_command(): script_command - 
at91sam926x_device
Debug:   20 24 command.c:108 script_command(): script_command - 
at91sam926x_device, argv[0]=ocd_at91sam926x_device
Debug:   21 24 command.c:108 script_command(): script_command - 
at91sam926x_device, argv[1]=jtag_A
Debug:   23 26 command.c:91 script_command(): script_command - reset_config
Debug:   24 27 command.c:108 script_command(): script_command - 
reset_config, argv[0]=ocd_reset_config
Debug:   25 27 command.c:108 script_command(): script_command - 
reset_config, argv[1]=trst_and_srst
Debug:   27 29 command.c:91 script_command(): script_command - 
jtag_nsrst_delay
Debug:   28 29 command.c:108 script_command(): script_command - 
jtag_nsrst_delay, argv[0]=ocd_jtag_nsrst_delay
Debug:   29 30 command.c:108 script_command(): script_command - 
jtag_nsrst_delay, argv[1]=20
Debug:   31 32 command.c:91 script_command(): script_command - 
jtag_ntrst_delay
Debug:   32 32 command.c:108 script_command(): script_command - 
jtag_ntrst_delay, argv[0]=ocd_jtag_ntrst_delay
Debug:   33 33 command.c:108 script_command(): script_command - 
jtag_ntrst_delay, argv[1]=20
Debug:   34 34 jtag.c:1847 jim_newtap_cmd(): Creating New Tap, Chip: 
at91sam9263, Tap: cpu, Dotted: at91sam9263.cpu, 8 params
Debug:   35 35 jtag.c:1866 jim_newtap_cmd(): Processing option: -irlen
Debug:   36 35 jtag.c:1866 jim_newtap_cmd(): Processing option: -ircapture
Debug:   37 36 jtag.c:1866 jim_newtap_cmd(): Processing option: -irmask
Debug:   38 36 jtag.c:1866 jim_newtap_cmd(): Processing option: -expected-id
Debug:   39 37 jtag.c:1979 jim_newtap_cmd(): Created Tap: 
at91sam9263.cpu @ abs position 0, irlen 4, capture: 0x1 mask: 0xf
Debug:   40 38 target.c:3911 jim_target(): Target command params:
Debug:   41 39 target.c:3912 jim_target(): target create at91sam9263.cpu 
arm926ejs -endian little -chain-position at91sam9263.cpu -variant arm926ejs
Debug:   43 58 command.c:91 script_command(): script_command - bank
Debug:   44 59 command.c:108 script_command(): script_command - bank, 
argv[0]=ocd_flash_bank
Debug:   45 59 command.c:108 script_command(): script_command - bank, 
argv[1]=cfi
Debug:   46 60 command.c:108 script_command(): script_command - bank, 
argv[2]=0x10000000
Debug:   47 61 command.c:108 script_command(): script_command - bank, 
argv[3]=0x400000
Debug:   48 61 command.c:108 script_command(): script_command - bank, 
argv[4]=2
Debug:   49 62 command.c:108 script_command(): script_command - bank, 
argv[5]=2
Debug:   50 62 command.c:108 script_command(): script_command - bank, 
argv[6]=0
Debug:   52 64 command.c:91 script_command(): script_command - init
Debug:   53 65 command.c:108 script_command(): script_command - init, 
argv[0]=ocd_init
Debug:   54 82 openocd.c:144 handle_init_command(): target init complete
Debug:   55 83 openocd.c:151 handle_init_command(): jtag interface init 
complete
Debug:   56 84 jtag.c:2194 jtag_init_inner(): Init JTAG chain
Debug:   57 84 jtag.c:427 jtag_call_event_callbacks(): jtag event: JTAG 
controller reset (RESET or TRST)
Debug:   58 85 jtag.c:1444 jtag_reset_callback(): -



At this point it waits, waits...
The reason is hopefully in my configuration script or has the current 
openocd version some weaknesses?

############################################################
## Target:    Atmel AT91SAM9263
## Author:    Andreas Kuehn
############################################################

if { [info exists CHIPNAME] } {
    set  _CHIPNAME $CHIPNAME
} else {
    set  _CHIPNAME at91sam9263
}

if { [info exists ENDIAN] } {
    set  _ENDIAN $ENDIAN
} else {
    set  _ENDIAN little
}

if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
} else {
   # force an error till we get a good number
    set _CPUTAPID 0x0792603F
}

telnet_port 4444
gdb_port 3333

interface at91sam926x
at91sam926x_device jtag_A

reset_config trst_and_srst
jtag_nsrst_delay 20
jtag_ntrst_delay 20

jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf 
-expected-id $_CPUTAPID

set _TARGETNAME [format &quot;%s.cpu&quot; $_CHIPNAME]
target create $_TARGETNAME arm926ejs -endian $_ENDIAN -chain-position 
$_TARGETNAME -variant arm926ejs
$_TARGETNAME configure -work-area-virt 0x0 -work-area-phys 0x300000 
-work-area-size 0x100000
$_TARGETNAME configure -event halted &quot;script SAM9263_init.script&quot;

$_TARGETNAME configure -event reset-init {

	mww 0xFFFFFC20 0x00002001   # CKGR_MOR - enable main osc.
	mww 0xFFFFFC28 0x2018BF02   # CKGR_PLLA - (16.00MHz/2)*25 = 200 MHz
	sleep 20                    # delay 20ms
	mww 0xFFFFFC30 0x00000102   #  0x102 - (CLK/2)MHZ,
	sleep 200
	jtag_speed 4
	mww 0xFFFFFD44 0x00008000       # disable watchdog
	mww 0xFFFFFD08 0xA5000301       # user reset enable
	mww 0xFFFFFC10 0xFFFFFFFF       # PMC_PCER
	## setup EBI0_CS0 (NOR Flash) - 16-bit, 15 WS @ addr 0x10000000
	mww 0xFFFFE400 0x03030303       # SMC_SETUP
	mww 0xFFFFE404 0x09090909       # SMC_PULSE
	mww 0xFFFFE408 0x00120012       # SMC_CYCLE
	mww 0xFFFFE40C 0x00161003       # SMC_MODE
}

flash bank cfi 0x10000000 0x400000 2 2 0
init
############################################################


Duane Ellis wrote:
&gt;<i> andreas&gt; Program received signal SIGSEGV, Segmentation fault.
</I>&gt;<i> andreas&gt; 0x000519ec in interface_jtag_add_dr_out (device_num=0, 
</I>&gt;<i> num_fields=0, num_bits=0x2, value=0xf1040, end_state=TAP_RTI) at jtag.c:721
</I>&gt;<i> andreas&gt; 721             (*last_cmd)-&gt;cmd.scan-&gt;ir_scan = 0;
</I>&gt;<i> 
</I>&gt;<i> Hmm - Some ideas
</I>&gt;<i> 
</I>&gt;<i> 1) As rick asks - what SVN version of OpenOCD are you using?
</I>&gt;<i> 
</I>&gt;<i> Look at the file: &quot;jtag.c&quot; - function:  &quot;cmd_queue_allocate()' is there 
</I>&gt;<i> a *BIG*WARNING* comment that talks about alignment?
</I>&gt;<i> 
</I>&gt;<i> 2) Can you run openocd under gdb on your uCLinux box?
</I>&gt;<i> 
</I>&gt;<i> 3) Can you do this again (with newer SVN version) - line numbers do not 
</I>&gt;<i> match well.
</I>&gt;<i> Then - get a disassembly dump of the relevent section of the code.
</I>&gt;<i> There are 3 different pointers going on there., (a) (*last_cmd), (b) the 
</I>&gt;<i> -&gt; part, and (c) the value of &quot;.scan&quot;
</I>&gt;<i> By looking at the disassembly - and the address (ie: above it iwas 
</I>&gt;<i> 0x000519ec) one can figure out what pointer is bad
</I>&gt;<i> 
</I>&gt;<i> 4) you can perhaps configure uClinux to save a core file - and look at 
</I>&gt;<i> the register value @ the time of the crash
</I>&gt;<i> (other version of uCLinux - have a kernel config to dump/print the cpu 
</I>&gt;<i> registers when the above happens)
</I>&gt;<i> It would be helpful to determine what they where.
</I>&gt;<i> 
</I>&gt;<i> 5) A bunch of simplistic &quot;printf()&quot; statements at that point in the code 
</I>&gt;<i> would be very helpful.
</I>&gt;<i> for example:
</I>&gt;<i> 
</I>&gt;<i>    printf( &quot;LAST CMD = %p\n&quot;, last_cmd );
</I>&gt;<i>    printf(&quot; last command pointer = %p\n&quot;, last_command_ptr );
</I>&gt;<i>    .... and all the other ones.
</I>&gt;<i>    For example - print the return values of the &quot;cmd_queue_allocate()&quot; 
</I>&gt;<i> calls.
</I>&gt;<i> 
</I>&gt;<i> andreas&gt; So I did an strace with the same configuration. In fact ioctl 
</I>&gt;<i> calls are failing.
</I>&gt;<i> 
</I>&gt;<i> That might be perfectly valid.
</I>&gt;<i> 
</I>&gt;&gt;<i> After taking a deeper look to the code I found that &quot;fopen&quot; calls for 
</I>&gt;&gt;<i> the configuration files like this fail:
</I>&gt;<i> 
</I>&gt;<i> With out detail and context, it is hard to say what is happening here - 
</I>&gt;<i> it most likely is 100% NORMAL.
</I>&gt;<i> 
</I>&gt;<i> Example: When GCC is hunting for .H files you are #including, there are 
</I>&gt;<i> multiple fails.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- Duane.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004058.html">[Openocd-development] Unexpected idcode causing SIGSEGV ?
</A></li>
	<LI>Next message: <A HREF="004089.html">[Openocd-development] Unexpected idcode causing SIGSEGV ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4071">[ date ]</a>
              <a href="thread.html#4071">[ thread ]</a>
              <a href="subject.html#4071">[ subject ]</a>
              <a href="author.html#4071">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-development">More information about the Openocd-development
mailing list</a><br>
</body></html>
